# NSFW 检测器 - 批处理优化版本
# 使用动态批处理提高吞吐量

metadata:
  name: nsfw-detector
  namespace: nuclio
  labels:
    app: nsfw-detector
    version: "batch"

spec:
  runtime: python:3.12
  handler: main_batch:handler
  description: "NSFW 检测 - 批处理优化"
  
  resources:
    requests:
      cpu: "2"
      memory: "4Gi"
    limits:
      cpu: "8"
      memory: "10Gi"
  
  env:
    - name: NSFW_MODEL_NAME
      value: "Falconsai/nsfw_image_detection"
    - name: DEVICE
      value: "cpu"
    - name: PYTHONUNBUFFERED
      value: "1"
    # 批处理配置 - 4张图片一批
    - name: BATCH_SIZE
      value: "4"
    - name: BATCH_TIMEOUT_MS
      value: "5"
    # 单线程配置
    - name: OMP_NUM_THREADS
      value: "1"
    - name: MKL_NUM_THREADS
      value: "1"
    - name: OPENBLAS_NUM_THREADS
      value: "1"
    - name: VECLIB_MAXIMUM_THREADS
      value: "1"
    - name: NUMEXPR_NUM_THREADS
      value: "1"
    - name: PYTORCH_NUM_THREADS
      value: "1"
  
  build:
    path: ./functions/nsfw-detector
    baseImage: python:3.12-slim
    commands:
      - apt-get update && apt-get install -y --no-install-recommends libgl1 libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 wget git && rm -rf /var/lib/apt/lists/*
      - pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
      - pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
      - pip install --no-cache-dir torch torchvision transformers Pillow numpy requests
      - mkdir -p /opt/huggingface/models
      - export HF_HOME=/opt/huggingface && export TRANSFORMERS_CACHE=/opt/huggingface/models
      - python3 -c "from transformers import AutoModelForImageClassification, AutoImageProcessor; m='Falconsai/nsfw_image_detection'; AutoImageProcessor.from_pretrained(m, cache_dir='/opt/huggingface/models'); AutoModelForImageClassification.from_pretrained(m, cache_dir='/opt/huggingface/models'); print('Model downloaded')"
  
  triggers:
    http:
      kind: http
      # 更多 worker 来处理并发请求
      numWorkers: 16
      workerAvailabilityTimeoutMilliseconds: 60000
      attributes:
        maxRequestBodySize: 33554432
  
  minReplicas: 1
  maxReplicas: 1
  
  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
  
  loggerSinks:
    - level: warning
      sink: ""
