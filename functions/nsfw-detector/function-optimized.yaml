# NSFW 检测器 - 最终优化版本
# 基于性能测试结果优化：
# - 本地图片延迟 335ms，URL 图片额外增加约 1200ms 下载时间
# - 最佳并发 6-8，QPS 约 12-13
# - 超过 8 并发后 QPS 不再增长（CPU 瓶颈）

metadata:
  name: nsfw-detector
  namespace: nuclio
  labels:
    app: nsfw-detector
    version: "optimized"

spec:
  runtime: python:3.12
  handler: main:handler
  description: "NSFW 检测 - 性能优化版"
  
  resources:
    requests:
      cpu: "2"
      memory: "4Gi"
    limits:
      cpu: "8"
      memory: "10Gi"
  
  env:
    - name: NSFW_MODEL_NAME
      value: "Falconsai/nsfw_image_detection"
    - name: DEVICE
      value: "cpu"
    - name: PYTHONUNBUFFERED
      value: "1"
    # 单线程配置 - 多 worker 比多线程更有效
    - name: OMP_NUM_THREADS
      value: "1"
    - name: MKL_NUM_THREADS
      value: "1"
    - name: OPENBLAS_NUM_THREADS
      value: "1"
    - name: VECLIB_MAXIMUM_THREADS
      value: "1"
    - name: NUMEXPR_NUM_THREADS
      value: "1"
    - name: PYTORCH_NUM_THREADS
      value: "1"
    # 启用 TorchScript 优化
    - name: TORCH_JIT_ENABLED
      value: "1"
  
  build:
    path: ./functions/nsfw-detector
    baseImage: python:3.12-slim
    commands:
      - apt-get update && apt-get install -y --no-install-recommends libgl1 libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 wget git && rm -rf /var/lib/apt/lists/*
      - pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
      - pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
      # 安装优化版 PyTorch (使用 OpenBLAS)
      - pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cpu
      - pip install --no-cache-dir transformers Pillow numpy requests
      # 预下载模型
      - mkdir -p /opt/huggingface/models
      - export HF_HOME=/opt/huggingface && export TRANSFORMERS_CACHE=/opt/huggingface/models
      - python3 -c "from transformers import AutoModelForImageClassification, AutoImageProcessor; m='Falconsai/nsfw_image_detection'; AutoImageProcessor.from_pretrained(m, cache_dir='/opt/huggingface/models'); AutoModelForImageClassification.from_pretrained(m, cache_dir='/opt/huggingface/models'); print('Model downloaded')"
  
  triggers:
    http:
      kind: http
      # 8 workers = CPU 核心数，每个 worker 独占 1 核心
      numWorkers: 8
      workerAvailabilityTimeoutMilliseconds: 30000
      attributes:
        maxRequestBodySize: 33554432
  
  minReplicas: 1
  maxReplicas: 1
  
  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
  
  loggerSinks:
    - level: warning
      sink: ""
