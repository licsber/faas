# NSFW 检测器 - CPU 版本
# 用于生产环境或没有 GPU 的场景

metadata:
  name: nsfw-detector
  namespace: nuclio
  labels:
    app: nsfw-detector
    version: "1"
    hardware: cpu

spec:
  runtime: python:3.12
  handler: main:handler
  description: "NSFW 图像内容检测服务 - CPU 版本"

  # 资源配置 - 充分利用 14GB 内存
  resources:
    requests:
      cpu: "500m"
      memory: "3Gi"
    limits:
      cpu: "8"       # 8 核 CPU 全用上
      memory: "12Gi"  # 14GB - 2GB 系统预留 = 12GB 给应用

  # 环境变量
  env:
    - name: NSFW_MODEL_NAME
      value: "Falconsai/nsfw_image_detection"
    - name: DEVICE
      value: "cpu"
    - name: PYTHONUNBUFFERED
      value: "1"
    # CPU 线程优化：限制各库的线程数，避免多 worker 竞争
    - name: OMP_NUM_THREADS
      value: "1"
    - name: MKL_NUM_THREADS
      value: "1"
    - name: OPENBLAS_NUM_THREADS
      value: "1"
    - name: VECLIB_MAXIMUM_THREADS
      value: "1"
    - name: NUMEXPR_NUM_THREADS
      value: "1"

  # 构建配置
  build:
    path: ./functions/nsfw-detector
    baseImage: python:3.12-slim
    commands:
      # 安装系统依赖 (OpenCV 需要)
      - apt-get update && apt-get install -y --no-install-recommends libgl1 libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 wget git && rm -rf /var/lib/apt/lists/*
      # 配置清华源
      - pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
      - pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
      # 安装 Python 依赖
      - pip install --no-cache-dir torch torchvision transformers Pillow numpy requests
      # 预下载模型到镜像中（避免运行时下载）
      - mkdir -p /opt/huggingface/models
      - export HF_HOME=/opt/huggingface && export TRANSFORMERS_CACHE=/opt/huggingface/models && export HF_DATASETS_CACHE=/opt/huggingface/datasets
      - python3 -c "from transformers import AutoModelForImageClassification, AutoImageProcessor; m='Falconsai/nsfw_image_detection'; AutoImageProcessor.from_pretrained(m, cache_dir='/opt/huggingface/models'); AutoModelForImageClassification.from_pretrained(m, cache_dir='/opt/huggingface/models'); print('Model downloaded to /opt/huggingface/models')"
      - ls -la /opt/huggingface/models/

  # 触发器配置 - HTTP 触发器
  triggers:
    http:
      kind: http
      numWorkers: 18  # 12GB / 600MB ≈ 20，保守设 18 个 worker
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432  # 32MB
        # 不指定 port，让 Nuclio 自动分配

  # 版本管理
  version: 1

  # 副本数 - Nuclio 根据负载自动扩缩容
  minReplicas: 1
  maxReplicas: 5  # 最大 5 个 Pod，每个 16 worker = 80 并发处理能力

  # 日志级别
  loggerSinks:
    - level: info
      sink: ""
