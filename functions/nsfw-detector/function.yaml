# NSFW 检测器 - CPU 版本
# 使用预构建镜像（包含模型）：licsber/nsfw-detector:latest

metadata:
  name: nsfw-detector
  namespace: nuclio
  labels:
    app: nsfw-detector
    version: "1"
    hardware: cpu
    nuclio.io/project-name: default

spec:
  runtime: python:3.12
  handler: main:handler
  description: "NSFW 图像内容检测服务 - CPU 版本（预构建镜像）"
  
  # 资源配置 - CPU/内存 优化比例 1:0.5 (8C:4G)
  resources:
    requests:
      cpu: "2"
      memory: "2Gi"
    limits:
      cpu: "8"
      memory: "4Gi"
  
  # 环境变量
  env:
    - name: NSFW_MODEL_NAME
      value: "Falconsai/nsfw_image_detection"
    - name: DEVICE
      value: "cpu"
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: HF_HOME
      value: "/opt/huggingface"
    - name: OMP_NUM_THREADS
      value: "1"
    - name: MKL_NUM_THREADS
      value: "1"
    - name: OPENBLAS_NUM_THREADS
      value: "1"
    - name: VECLIB_MAXIMUM_THREADS
      value: "1"
    - name: NUMEXPR_NUM_THREADS
      value: "1"
    - name: PYTORCH_NUM_THREADS
      value: "1"
  
  # 使用预构建镜像作为基础镜像（包含所有依赖和模型）
  build:
    path: ./functions/nsfw-detector
    baseImage: licsber/nsfw-detector:latest
    # 不运行额外命令，依赖已在基础镜像中
  
  # 触发器配置 - 8 workers 对应 8 CPU 核心
  triggers:
    http:
      kind: http
      numWorkers: 8
      workerAvailabilityTimeoutMilliseconds: 30000
      attributes:
        maxRequestBodySize: 33554432
        keepAlive: true
  
  # 副本数
  minReplicas: 1
  maxReplicas: 1
  
  # 平台配置
  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
  
  # 日志级别
  loggerSinks:
    - level: warning
      sink: ""
