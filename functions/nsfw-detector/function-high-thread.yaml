# NSFW 检测器 - 高线程优化版本
# 策略：减少 worker 数量，增加每个 worker 的线程数

metadata:
  name: nsfw-detector
  namespace: nuclio
  labels:
    app: nsfw-detector
    version: "high-thread"

spec:
  runtime: python:3.12
  handler: main:handler
  description: "NSFW 检测 - 高线程优化"
  
  resources:
    requests:
      cpu: "2"
      memory: "4Gi"
    limits:
      cpu: "8"
      memory: "10Gi"
  
  env:
    - name: NSFW_MODEL_NAME
      value: "Falconsai/nsfw_image_detection"
    - name: DEVICE
      value: "cpu"
    - name: PYTHONUNBUFFERED
      value: "1"
    # 关键优化：每个 worker 使用 4 线程
    - name: OMP_NUM_THREADS
      value: "4"
    - name: MKL_NUM_THREADS
      value: "4"
    - name: OPENBLAS_NUM_THREADS
      value: "4"
    - name: VECLIB_MAXIMUM_THREADS
      value: "4"
    - name: NUMEXPR_NUM_THREADS
      value: "4"
    # PyTorch 线程 - 让单个请求可以利用多核
    - name: PYTORCH_NUM_THREADS
      value: "4"
  
  build:
    path: ./functions/nsfw-detector
    baseImage: python:3.12-slim
    commands:
      - apt-get update && apt-get install -y --no-install-recommends libgl1 libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 wget git && rm -rf /var/lib/apt/lists/*
      - pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
      - pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
      - pip install --no-cache-dir torch torchvision transformers Pillow numpy requests
      - mkdir -p /opt/huggingface/models
      - export HF_HOME=/opt/huggingface && export TRANSFORMERS_CACHE=/opt/huggingface/models
      - python3 -c "from transformers import AutoModelForImageClassification, AutoImageProcessor; m='Falconsai/nsfw_image_detection'; AutoImageProcessor.from_pretrained(m, cache_dir='/opt/huggingface/models'); AutoModelForImageClassification.from_pretrained(m, cache_dir='/opt/huggingface/models'); print('Model downloaded')"
  
  triggers:
    http:
      kind: http
      # 2 workers * 4 threads = 8 核心充分利用
      numWorkers: 2
      workerAvailabilityTimeoutMilliseconds: 60000
      attributes:
        maxRequestBodySize: 33554432
  
  minReplicas: 1
  maxReplicas: 1
  
  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
  
  loggerSinks:
    - level: warning
      sink: ""
